name: Deploy Child Themes & Elementor Kits to Cloudways

on:
  push:
    branches:
      - staging # deploys to staging apps
      - main # deploys to production apps
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # --- Staging Sites ---
          - site: sparky
            env: staging
            brand: sparky-hq
            app_secret: APP_ROOT_SPARKY_STAGING
          - site: hezlep
            env: staging
            brand: hezlep-inc
            app_secret: APP_ROOT_HEZLEP_STAGING

          # --- Production Sites ---
          - site: sparky
            env: prod
            brand: sparky-hq
            app_secret: APP_ROOT_SPARKY_PROD
          - site: hezlep
            env: prod
            brand: hezlep-inc
            app_secret: APP_ROOT_HEZLEP_PROD

    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Show runner IP
      - name: Show runner IP
        run: |
          echo "Runner IP: $(curl -s https://api.ipify.org)"

      # 3. Write SSH key and known_hosts
      - name: Prepare SSH key
        run: |
          echo "${{ secrets.CLOUDWAYS_SSH_KEY }}" > key.pem
          # Normalize CRLF just in case
          sed -i -e 's/\r$//' key.pem || true
          chmod 600 key.pem
          ssh-keyscan -H "${{ secrets.CLOUDWAYS_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null || true

      # 4. Verify the runner is using the same key (fingerprint)
      - name: SSH key fingerprint test
        run: |
          echo "Runner SSH key fingerprint:"
          ssh-keygen -lf key.pem

      # 5. Quick SSH connection check
      - name: Verify SSH connectivity
        env:
          CW_HOST: ${{ secrets.CLOUDWAYS_HOST }}
          CW_USER: ${{ secrets.CLOUDWAYS_USER }}
        run: |
          ssh -i key.pem -o StrictHostKeyChecking=no -o IdentitiesOnly=yes -o ConnectTimeout=15 \
            ${CW_USER}@${CW_HOST} "echo ‚úÖ Connected successfully as $(whoami)"

      # 6. Assemble Hello Child Theme
      - name: Assemble Hello Child Theme
        run: |
          set -e
          echo "üèóÔ∏è  Building theme for brand: ${{ matrix.brand }}"
          rm -rf infra/build/hello-child
          mkdir -p infra/build/hello-child
          # Base shared child theme
          rsync -a infra/wordpress/themes/hello-child/ infra/build/hello-child/
          # Brand overlay (optional)
          if [ -d "infra/wordpress/brands/${{ matrix.brand }}/theme" ]; then
            rsync -a infra/wordpress/brands/${{ matrix.brand }}/theme/ infra/build/hello-child/
          fi
          # Version stamp in style.css
          if [ -f infra/build/hello-child/style.css ]; then
            ver=$(date +"%Y.%m.%d-%H%M")
            sed -i -e "s/^Version:.*/Version: ${ver}/" infra/build/hello-child/style.css || true
          fi

      # 6b. Copy brand tokens CSS if present
      - name: Copy brand tokens CSS (optional)
        run: |
          set -e
          mkdir -p infra/build/hello-child/assets/css
          CSS_SRC="infra/wordpress/brands/${{ matrix.brand }}/assets/css/cursor.css"
          if [ -f "$CSS_SRC" ]; then
            cp "$CSS_SRC" infra/build/hello-child/assets/css/cursor.css
            echo "Copied tokens CSS for ${{ matrix.brand }}"
          else
            echo "No tokens CSS at $CSS_SRC (skipping)"
          fi

      # 7. Deploy Hello Child Theme
      - name: Deploy Hello Child Theme
        env:
          APP_ROOT: ${{ secrets[matrix.app_secret] }}
          CW_HOST: ${{ secrets.CLOUDWAYS_HOST }}
          CW_USER: ${{ secrets.CLOUDWAYS_USER }}
        run: |
          set -e
          echo "üöÄ Deploying Hello Child theme to: $APP_ROOT"
          ssh -i key.pem -o StrictHostKeyChecking=no ${CW_USER}@${CW_HOST} "mkdir -p ${APP_ROOT}/wp-content/themes/hello-child"
          rsync -azvP --no-perms --no-times --omit-dir-times --delete -e "ssh -i key.pem -o StrictHostKeyChecking=no" \
            infra/build/hello-child/ \
            ${CW_USER}@${CW_HOST}:${APP_ROOT}/wp-content/themes/hello-child/

      # 8. Upload Elementor Kit
      - name: Upload Elementor Kit
        env:
          APP_ROOT: ${{ secrets[matrix.app_secret] }}
          CW_HOST: ${{ secrets.CLOUDWAYS_HOST }}
          CW_USER: ${{ secrets.CLOUDWAYS_USER }}
        run: |
          set -e
          echo "üì¶ Uploading Elementor Kit for brand: ${{ matrix.brand }}"
          KIT="infra/wordpress/brands/${{ matrix.brand }}/elementor/cursor-sitekit-${{ matrix.brand }}.zip"
          if [ ! -f "$KIT" ]; then
            KIT="infra/wordpress/brands/${{ matrix.brand }}/elementor/cursor-sitekit.zip"
          fi
          rsync -azP --no-perms --no-times -e "ssh -i key.pem -o StrictHostKeyChecking=no" "$KIT" \
            ${CW_USER}@${CW_HOST}:${APP_ROOT}/cursor-sitekit.zip

      # 9. Import Elementor Kit + Activate Theme
      - name: Import Elementor Kit + Activate Theme
        env:
          APP_ROOT: ${{ secrets[matrix.app_secret] }}
          CW_HOST: ${{ secrets.CLOUDWAYS_HOST }}
          CW_USER: ${{ secrets.CLOUDWAYS_USER }}
        run: |
          set -e
          echo "üîß Importing Elementor kit & activating theme..."
          ssh -i key.pem -o StrictHostKeyChecking=no ${CW_USER}@${CW_HOST} \
            "bash -lc 'set -e; cd \"${APP_ROOT}\"; \
              echo Activating Hello Child theme...; wp theme activate hello-child --allow-root || true; \
              echo Importing Elementor Kit...; wp elementor kit import cursor-sitekit.zip --allow-root || true; \
              echo Flushing cache...; wp cache flush --allow-root || true; \
              if wp plugin is-installed breeze --allow-root; then wp breeze purge --allow-root || true; fi'"

      # 10. Verify remote theme directory
      - name: Verify remote theme directory
        env:
          APP_ROOT: ${{ secrets[matrix.app_secret] }}
          CW_HOST: ${{ secrets.CLOUDWAYS_HOST }}
          CW_USER: ${{ secrets.CLOUDWAYS_USER }}
        run: |
          ssh -i key.pem -o StrictHostKeyChecking=no ${CW_USER}@${CW_HOST} \
            "ls -lah ${APP_ROOT}/wp-content/themes/hello-child && echo '‚úÖ Theme deployed successfully'"

      # 11. Cleanup
      - name: Cleanup SSH key
        if: always()
        run: rm -f key.pem

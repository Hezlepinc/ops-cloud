name: Deploy Child Themes & Elementor Kits to Cloudways

on:
  push:
    branches:
      - staging # deploys to staging apps
      - main # deploys to production apps
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # --- Staging Sites ---
          - site: sparky
            env: staging
            brand: sparky-hq
            app_secret: APP_ROOT_SPARKY_STAGING
          - site: hezlep
            env: staging
            brand: hezlep-inc
            app_secret: APP_ROOT_HEZLEP_STAGING

          # --- Production Sites ---
          - site: sparky
            env: prod
            brand: sparky-hq
            app_secret: APP_ROOT_SPARKY_PROD
          - site: hezlep
            env: prod
            brand: hezlep-inc
            app_secret: APP_ROOT_HEZLEP_PROD

    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Show runner IP
      - name: Show runner IP
        run: |
          echo "Runner IP: $(curl -s https://api.ipify.org)"

      # 3. Write SSH key and known_hosts
      - name: Prepare SSH key
        run: |
          echo "${{ secrets.CLOUDWAYS_SSH_KEY }}" > key.pem
          # Normalize CRLF just in case
          sed -i -e 's/\r$//' key.pem || true
          chmod 600 key.pem
          ssh-keyscan -H "${{ secrets.CLOUDWAYS_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null || true

      # 4. Verify the runner is using the same key (fingerprint)
      - name: SSH key fingerprint test
        run: |
          echo "Runner SSH key fingerprint:"
          ssh-keygen -lf key.pem

      # 5. Quick SSH connection check
      - name: Verify SSH connectivity
        env:
          CW_HOST: ${{ secrets.CLOUDWAYS_HOST }}
          CW_USER: ${{ secrets.CLOUDWAYS_USER }}
        run: |
          ssh -i key.pem -o StrictHostKeyChecking=no -o IdentitiesOnly=yes -o ConnectTimeout=15 \
            ${CW_USER}@${CW_HOST} "echo âœ… Connected successfully as $(whoami)"

      # 6. Assemble Hello Child Theme
      - name: Assemble Hello Child Theme
        run: |
          set -e
          echo "ðŸ—ï¸  Building theme for brand: ${{ matrix.brand }}"
          rm -rf infra/build/hello-child
          mkdir -p infra/build/hello-child
          # Base shared child theme
          rsync -a infra/wordpress/themes/hello-child/ infra/build/hello-child/
          # Brand overlay (optional)
          if [ -d "infra/wordpress/brands/${{ matrix.brand }}/theme" ]; then
            rsync -a infra/wordpress/brands/${{ matrix.brand }}/theme/ infra/build/hello-child/
          fi
          # Version stamp in style.css
          if [ -f infra/build/hello-child/style.css ]; then
            ver=$(date +"%Y.%m.%d-%H%M")
            sed -i -e "s/^Version:.*/Version: ${ver}/" infra/build/hello-child/style.css || true
          fi

      # 6b. Copy brand tokens CSS if present
      - name: Copy brand tokens CSS (optional)
        run: |
          set -e
          mkdir -p infra/build/hello-child/assets/css
          CSS_SRC="infra/wordpress/brands/${{ matrix.brand }}/assets/css/cursor.css"
          if [ -f "$CSS_SRC" ]; then
            cp "$CSS_SRC" infra/build/hello-child/assets/css/cursor.css
            echo "Copied tokens CSS for ${{ matrix.brand }}"
          else
            echo "No tokens CSS at $CSS_SRC (skipping)"
          fi

      # 7. Deploy Hello Child Theme
      - name: Deploy Hello Child Theme
        env:
          APP_ROOT: ${{ secrets[matrix.app_secret] }}
          CW_HOST: ${{ secrets.CLOUDWAYS_HOST }}
          CW_USER: ${{ secrets.CLOUDWAYS_USER }}
        run: |
          set -e
          echo "ðŸš€ Deploying Hello Child theme to: $APP_ROOT"
          ssh -i key.pem -o StrictHostKeyChecking=no ${CW_USER}@${CW_HOST} "mkdir -p ${APP_ROOT}/wp-content/themes/hello-child"
          rsync -azvP --no-perms --no-times --omit-dir-times --delete -e "ssh -i key.pem -o StrictHostKeyChecking=no" \
            infra/build/hello-child/ \
            ${CW_USER}@${CW_HOST}:${APP_ROOT}/wp-content/themes/hello-child/

      # 8. Upload brand assets (elementor kits, assets, etc.)
      - name: Upload brand assets
        env:
          APP_ROOT: ${{ secrets[matrix.app_secret] }}
          CW_HOST: ${{ secrets.CLOUDWAYS_HOST }}
          CW_USER: ${{ secrets.CLOUDWAYS_USER }}
        run: |
          set -e
          echo "ðŸ“¦ Uploading brand directory for: ${{ matrix.brand }} -> brand/${{ matrix.site }}"
          ssh -i key.pem -o StrictHostKeyChecking=no ${CW_USER}@${CW_HOST} "mkdir -p ${APP_ROOT}/brand/${{ matrix.site }}"
          rsync -azP --no-perms --no-times -e "ssh -i key.pem -o StrictHostKeyChecking=no" \
            infra/wordpress/brands/${{ matrix.brand }}/ \
            ${CW_USER}@${CW_HOST}:${APP_ROOT}/brand/${{ matrix.site }}/

      # 9. Ensure Elementor + parent theme, activate child, import kit
      - name: Ensure Elementor and parent theme; activate child; import kit
        env:
          APP_ROOT: ${{ secrets[matrix.app_secret] }}
          CW_HOST: ${{ secrets.CLOUDWAYS_HOST }}
          CW_USER: ${{ secrets.CLOUDWAYS_USER }}
        run: |
          set -e
          echo "ðŸ”§ Ensuring Elementor + Hello parent, activating child, and importing kit..."
          ssh -i key.pem -o StrictHostKeyChecking=no ${CW_USER}@${CW_HOST} \
            "bash -lc 'set -e; cd \"${APP_ROOT}\"; \
              # Ensure Elementor installed/active
              wp plugin is-installed elementor --allow-root || wp plugin install elementor --activate --allow-root; \
              # Best-effort Pro activation if present (ignore failure)
              wp plugin activate elementor-pro --allow-root || true; \
              # Ensure Hello Elementor parent theme
              wp theme is-installed hello-elementor --allow-root || wp theme install hello-elementor --allow-root; \
              echo Activating Hello Child theme...; wp theme activate hello-child --allow-root || true; \
              KIT_DIR=\"brand/${{ matrix.site }}/elementor\"; \
              if compgen -G \"$KIT_DIR/*.zip\" > /dev/null; then \
                KIT=\"$(ls -1 $KIT_DIR/*.zip | head -n 1)\"; echo Importing kit $KIT ...; wp elementor kit import \"$KIT\" --allow-root || true; \
              elif compgen -G \"$KIT_DIR/*.json\" > /dev/null; then \
                KIT=\"$(ls -1 $KIT_DIR/*.json | head -n 1)\"; echo Importing kit $KIT ...; wp elementor kit import \"$KIT\" --allow-root || true; \
              else \
                echo \"No kit found in $KIT_DIR\"; \
              fi; \
              echo Flushing cache...; wp cache flush --allow-root || true; \
              if wp plugin is-installed breeze --allow-root; then wp breeze purge --allow-root || true; fi'"

      # 10. Verify remote theme directory
      - name: Verify remote theme directory
        env:
          APP_ROOT: ${{ secrets[matrix.app_secret] }}
          CW_HOST: ${{ secrets.CLOUDWAYS_HOST }}
          CW_USER: ${{ secrets.CLOUDWAYS_USER }}
        run: |
          ssh -i key.pem -o StrictHostKeyChecking=no ${CW_USER}@${CW_HOST} \
            "ls -lah ${APP_ROOT}/wp-content/themes/hello-child && echo 'âœ… Theme deployed successfully'"

      # 11. Cleanup
      - name: Cleanup SSH key
        if: always()
        run: rm -f key.pem

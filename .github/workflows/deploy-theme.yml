name: Deploy WP Themes & Kits

on:
  push:
    branches: [staging, main]
  repository_dispatch:
    types: [deploy-templates]

jobs:
  build-matrix:
    name: Build deploy matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      - id: set-matrix
        run: |
          node -e '
            const fs = require("fs");
            const p = JSON.parse(fs.readFileSync("infra/wordpress/config/projects.json", "utf8"));
            
            // Determine environment from branch or repository_dispatch payload
            let env = "staging";
            let requestedBrand = null;
            
            if (process.env.GITHUB_EVENT_NAME === "repository_dispatch") {
              const event = JSON.parse(fs.readFileSync(process.env.GITHUB_EVENT_PATH, "utf8"));
              const payload = event.client_payload || {};
              env = payload.environment === "production" ? "prod" : "staging";
              requestedBrand = payload.brand; // "sparky" or "hezlepinc"
            } else {
              const branch = process.env.GITHUB_REF_NAME;
              env = branch === "main" ? "prod" : "staging";
            }
            
            // Map orchestrator brand keys to config file keys
            const brandMap = {
              "sparky": "sparky-hq",
              "hezlepinc": "hezlep-inc"
            };
            
            const include = [];
            for (const [configBrand, v] of Object.entries(p)) {
              // If specific brand requested, filter to that brand
              if (requestedBrand) {
                const mappedBrand = brandMap[requestedBrand];
                if (configBrand !== mappedBrand) continue;
              }
              
              const envKey = env === "prod" ? "production" : "staging";
              // Use orchestrator brand key for workflow
              const workflowBrand = Object.keys(brandMap).find(k => brandMap[k] === configBrand) || configBrand;
              include.push({ 
                brand: workflowBrand, 
                configBrand: configBrand,
                overlay: v.overlay_theme || "hello-child", 
                domain: v[envKey].domain, 
                app_root_secret: v[envKey].app_root_secret || `APP_ROOT_${workflowBrand.toUpperCase()}_${envKey.toUpperCase()}`, 
                env 
              });
            }
            process.stdout.write(JSON.stringify({ include }));
          ' > matrix.json
          echo "matrix=$(cat matrix.json)" >> $GITHUB_OUTPUT

  deploy:
    needs: build-matrix
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.build-matrix.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4

      - name: Prepare SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.CLOUDWAYS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.CLOUDWAYS_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Set APP_ROOT from secret
        run: echo "APP_ROOT=${{ secrets[matrix.app_root_secret] }}" >> $GITHUB_ENV

      - name: Rsync ops-base
        env:
          CW_HOST: ${{ secrets.CLOUDWAYS_HOST }}
          CW_USER: ${{ secrets.CLOUDWAYS_USER }}
        run: |
          set -e
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${CW_USER}@${CW_HOST} "mkdir -p ${APP_ROOT}/wp-content/themes/ops-base"
          rsync -azvP --no-perms --no-times --omit-dir-times --delete -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
            infra/wordpress/themes/ops-base/ \
            ${CW_USER}@${CW_HOST}:${APP_ROOT}/wp-content/themes/ops-base/

      - name: Rsync overlay theme
        env:
          CW_HOST: ${{ secrets.CLOUDWAYS_HOST }}
          CW_USER: ${{ secrets.CLOUDWAYS_USER }}
        run: |
          set -e
          OVERLAY_DIR="${{ matrix.overlay }}"
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${CW_USER}@${CW_HOST} "mkdir -p ${APP_ROOT}/wp-content/themes/$OVERLAY_DIR"
          rsync -azvP --no-perms --no-times --omit-dir-times --delete -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
            infra/wordpress/themes/overlays/${OVERLAY_DIR}/ \
            ${CW_USER}@${CW_HOST}:${APP_ROOT}/wp-content/themes/$OVERLAY_DIR/

      - name: Upload MU plugins, brands, config, and scripts
        env:
          CW_HOST: ${{ secrets.CLOUDWAYS_HOST }}
          CW_USER: ${{ secrets.CLOUDWAYS_USER }}
        run: |
          set -e
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${CW_USER}@${CW_HOST} "mkdir -p ${APP_ROOT}/wp-content/mu-plugins ${APP_ROOT}/infra/wordpress/bin ${APP_ROOT}/infra/wordpress/config ${APP_ROOT}/infra/wordpress/brands"
          rsync -azP --no-perms --no-times -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" infra/wordpress/mu-plugins/ ${CW_USER}@${CW_HOST}:${APP_ROOT}/wp-content/mu-plugins/
          rsync -azP --no-perms --no-times -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" infra/wordpress/brands/     ${CW_USER}@${CW_HOST}:${APP_ROOT}/infra/wordpress/brands/
          rsync -azP --no-perms --no-times -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" infra/wordpress/config/     ${CW_USER}@${CW_HOST}:${APP_ROOT}/infra/wordpress/config/
          rsync -azP --no-perms --no-times -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" infra/wordpress/wp-bootstrap.sh ${CW_USER}@${CW_HOST}:${APP_ROOT}/infra/wordpress/wp-bootstrap.sh
          rsync -azP --no-perms --no-times -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" infra/wordpress/bin/        ${CW_USER}@${CW_HOST}:${APP_ROOT}/infra/wordpress/bin/

      - name: Run bootstrap (activate overlay + import kits)
        env:
          CW_HOST: ${{ secrets.CLOUDWAYS_HOST }}
          CW_USER: ${{ secrets.CLOUDWAYS_USER }}
        run: |
          set -e
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${CW_USER}@${CW_HOST} <<EOF
          set -e
          APP_ROOT="${APP_ROOT}"
          cd "$APP_ROOT"
          sed -i -e 's/\r$//' infra/wordpress/wp-bootstrap.sh infra/wordpress/bin/import-kits.sh || true
          awk 'NR==1{sub(/^\xef\xbb\xbf/,"")}1' infra/wordpress/wp-bootstrap.sh > /tmp/wp-bootstrap.sh && mv /tmp/wp-bootstrap.sh infra/wordpress/wp-bootstrap.sh
          awk 'NR==1{sub(/^\xef\xbb\xbf/,"")}1' infra/wordpress/bin/import-kits.sh > /tmp/import-kits.sh && mv /tmp/import-kits.sh infra/wordpress/bin/import-kits.sh
          chmod +x infra/wordpress/bin/import-kits.sh infra/wordpress/wp-bootstrap.sh
          bash infra/wordpress/wp-bootstrap.sh '${{ matrix.configBrand || matrix.brand }}' '${{ matrix.env }}'
          EOF

      - name: HTTP health check
        run: |
          echo "Checking https://${{ matrix.domain }}"
          for i in 1 2 3; do
            code=$(curl -s -o /dev/null -w "%{http_code}" https://${{ matrix.domain }})
            echo "Attempt $i - HTTP $code"
            if [ "$code" = "200" ]; then result=ok; break; else result=bad; fi
            sleep 5
          done
          if [ "$result" != "ok" ]; then
            if [ "${{ matrix.env }}" = "prod" ]; then
              echo "Health check failed for https://${{ matrix.domain }}" && exit 1
            else
              echo "Warning: non-200 on staging (${code}), continuing"
            fi
          fi

      - name: Remote sanity checks (header/footer present)
        env:
          CW_HOST: ${{ secrets.CLOUDWAYS_HOST }}
          CW_USER: ${{ secrets.CLOUDWAYS_USER }}
        run: |
          set -e
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${CW_USER}@${CW_HOST} <<EOF
          set -e
          APP_ROOT="${APP_ROOT}"
          cd "$APP_ROOT"
          H=$(wp post list --post_type=elementor_library --search=Header --field=ID --allow-root | head -n1 || true)
          F=$(wp post list --post_type=elementor_library --search=Footer --field=ID --allow-root | head -n1 || true)
          echo "HeaderID=${H:-none} FooterID=${F:-none}"
          test -n "$H" && test -n "$F"
          EOF

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/id_rsa

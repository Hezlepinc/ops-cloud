name: Deploy WP Themes & Kits

on:
  push:
    branches: [staging, main]
  repository_dispatch:
    types: [deploy-templates]
  workflow_dispatch: {}

jobs:
  build-matrix:
    name: Build deploy matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      - id: set-matrix
        run: |
          node -e '
            const fs = require("fs");
            const p = JSON.parse(fs.readFileSync("infra/wordpress/config/projects.json", "utf8"));

            // Determine environment from branch or repository_dispatch payload
            let env = "staging";
            let requestedBrand = null;

            if (process.env.GITHUB_EVENT_NAME === "repository_dispatch") {
              const event = JSON.parse(fs.readFileSync(process.env.GITHUB_EVENT_PATH, "utf8"));
              const payload = event.client_payload || {};
              env = payload.environment === "production" ? "prod" : "staging";
              requestedBrand = payload.brand; // "sparky" or "hezlepinc"
            } else {
              const branch = process.env.GITHUB_REF_NAME;
              env = branch === "main" ? "prod" : "staging";
            }

            // Map orchestrator brand keys to config file keys
            const brandMap = {
              "sparky": "sparky-hq",
              "hezlepinc": "hezlep-inc"
            };

            const include = [];
            for (const [configBrand, v] of Object.entries(p)) {
              // If specific brand requested, filter to that brand
              if (requestedBrand) {
                const mappedBrand = brandMap[requestedBrand];
                if (configBrand !== mappedBrand) continue;
              }

              const envKey = env === "prod" ? "production" : "staging";
              // Use orchestrator brand key for workflow
              const workflowBrand = Object.keys(brandMap).find(k => brandMap[k] === configBrand) || configBrand;
              include.push({
                brand: workflowBrand,
                configBrand: configBrand,
                overlay: v.overlay_theme || "hello-child",
                domain: v[envKey].domain,
                app_root_secret: v[envKey].app_root_secret || `APP_ROOT_${workflowBrand.toUpperCase()}_${envKey.toUpperCase()}`,
                env
              });
            }
            process.stdout.write(JSON.stringify({ include }));
          ' > matrix.json
          echo "matrix=$(cat matrix.json)" >> $GITHUB_OUTPUT

  deploy:
    needs: build-matrix
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.build-matrix.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node for design pipeline
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Generate Astra theme.json and cursor.css
        run: |
          set -e
          BRAND="${{ matrix.configBrand || matrix.brand }}"
          echo "Generating design assets for brand=${BRAND}"
          node scripts/design/generate-theme-json.mjs --brand="${BRAND}"
          node scripts/design/generate-cursor-css.mjs --brand="${BRAND}"

      - name: Build Astra pages from sitemap
        run: |
          set -e
          BRAND="${{ matrix.configBrand || matrix.brand }}"
          echo "Building pages for brand=${BRAND}"
          node scripts/design/buildpages.mjs --brand="${BRAND}"

      - name: Prepare SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.CLOUDWAYS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.CLOUDWAYS_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Set APP_ROOT from secret
        run: echo "APP_ROOT=${{ secrets[matrix.app_root_secret] }}" >> $GITHUB_ENV

      - name: Rsync ops-base
        env:
          CW_HOST: ${{ secrets.CLOUDWAYS_HOST }}
          CW_USER: ${{ secrets.CLOUDWAYS_USER }}
        run: |
          set -e
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${CW_USER}@${CW_HOST} "mkdir -p ${APP_ROOT}/wp-content/themes/ops-base"
          rsync -azvP --no-perms --no-times --omit-dir-times --delete -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
            infra/wordpress/themes/ops-base/ \
            ${CW_USER}@${CW_HOST}:${APP_ROOT}/wp-content/themes/ops-base/

      - name: Rsync Astra child theme
        env:
          CW_HOST: ${{ secrets.CLOUDWAYS_HOST }}
          CW_USER: ${{ secrets.CLOUDWAYS_USER }}
        run: |
          set -e
          THEME_DIR="astra-child"
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${CW_USER}@${CW_HOST} "mkdir -p ${APP_ROOT}/wp-content/themes/$THEME_DIR"
          rsync -azvP --no-perms --no-times --omit-dir-times --delete -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
            infra/wordpress/themes/astra-child/ \
            ${CW_USER}@${CW_HOST}:${APP_ROOT}/wp-content/themes/$THEME_DIR/

      - name: Upload MU plugins, brands, config, and scripts
        env:
          CW_HOST: ${{ secrets.CLOUDWAYS_HOST }}
          CW_USER: ${{ secrets.CLOUDWAYS_USER }}
        run: |
          set -e
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${CW_USER}@${CW_HOST} "mkdir -p ${APP_ROOT}/wp-content/mu-plugins ${APP_ROOT}/infra/wordpress/bin ${APP_ROOT}/infra/wordpress/config ${APP_ROOT}/infra/wordpress/brands ${APP_ROOT}/deploy/wp-cli"
          rsync -azP --no-perms --no-times -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" infra/wordpress/mu-plugins/ ${CW_USER}@${CW_HOST}:${APP_ROOT}/wp-content/mu-plugins/
          rsync -azP --no-perms --no-times -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" infra/wordpress/brands/     ${CW_USER}@${CW_HOST}:${APP_ROOT}/infra/wordpress/brands/
          rsync -azP --no-perms --no-times -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" infra/wordpress/config/     ${CW_USER}@${CW_HOST}:${APP_ROOT}/infra/wordpress/config/
          rsync -azP --no-perms --no-times -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" infra/wordpress/wp-bootstrap.sh ${CW_USER}@${CW_HOST}:${APP_ROOT}/infra/wordpress/wp-bootstrap.sh
          rsync -azP --no-perms --no-times -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" infra/wordpress/bin/        ${CW_USER}@${CW_HOST}:${APP_ROOT}/infra/wordpress/bin/
          rsync -azP --no-perms --no-times -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" deploy/wp-cli/             ${CW_USER}@${CW_HOST}:${APP_ROOT}/deploy/wp-cli/

      - name: Run bootstrap (activate Astra child theme)
        env:
          CW_HOST: ${{ secrets.CLOUDWAYS_HOST }}
          CW_USER: ${{ secrets.CLOUDWAYS_USER }}
        run: |
          set -e
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${CW_USER}@${CW_HOST} <<EOF
          set -e
          APP_ROOT="${APP_ROOT}"
          cd "$APP_ROOT"
          sed -i -e 's/\r$//' infra/wordpress/wp-bootstrap.sh || true
          awk 'NR==1{sub(/^\xef\xbb\xbf/,"")}1' infra/wordpress/wp-bootstrap.sh > /tmp/wp-bootstrap.sh && mv /tmp/wp-bootstrap.sh infra/wordpress/wp-bootstrap.sh
          chmod +x infra/wordpress/wp-bootstrap.sh
          bash infra/wordpress/wp-bootstrap.sh '${{ matrix.configBrand || matrix.brand }}' '${{ matrix.env }}'
          EOF

      - name: Apply polish (pages, menus, home)
        env:
          CW_HOST: ${{ secrets.CLOUDWAYS_HOST }}
          CW_USER: ${{ secrets.CLOUDWAYS_USER }}
        run: |
          set -e
          BRAND="${{ matrix.brand }}"
          # Map brand names for polish script
          if [ "$BRAND" = "hezlepinc" ]; then
            POLISH_BRAND="hezlep"
          elif [ "$BRAND" = "sparky" ]; then
            POLISH_BRAND="sparky"
          else
            echo "Skipping polish for unknown brand: $BRAND"
            exit 0
          fi
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${CW_USER}@${CW_HOST} \
            "cd ${APP_ROOT} && wp eval-file deploy/wp-cli/polish_setup.php ${POLISH_BRAND} --allow-root"

      - name: HTTP health check
        run: |
          echo "Checking https://${{ matrix.domain }}"
          for i in 1 2 3; do
            code=$(curl -s -o /dev/null -w "%{http_code}" https://${{ matrix.domain }})
            echo "Attempt $i - HTTP $code"
            if [ "$code" = "200" ]; then result=ok; break; else result=bad; fi
            sleep 5
          done
          if [ "$result" != "ok" ]; then
            if [ "${{ matrix.env }}" = "prod" ]; then
              echo "Health check failed for https://${{ matrix.domain }}" && exit 1
            else
              echo "Warning: non-200 on staging (${code}), continuing"
            fi
          fi

      - name: Remote sanity checks (Astra child theme active)
        env:
          CW_HOST: ${{ secrets.CLOUDWAYS_HOST }}
          CW_USER: ${{ secrets.CLOUDWAYS_USER }}
        run: |
          set -e
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${CW_USER}@${CW_HOST} <<EOF
          set -e
          APP_ROOT="${APP_ROOT}"
          cd "$APP_ROOT"
          ACTIVE_SLUG=$(wp theme list --status=active --field=stylesheet --allow-root | head -n1 || true)
          echo "Active theme slug: ${ACTIVE_SLUG:-none}"
          # Check for either preferred theme or fallback
          if [ "${ACTIVE_SLUG}" != "hezlep-child-theme" ] && [ "${ACTIVE_SLUG}" != "astra-child" ]; then
            echo "⚠️  Expected hezlep-child-theme or astra-child to be active theme, but found '${ACTIVE_SLUG:-none}'"
            if [ "${{ matrix.env }}" = "prod" ]; then
              exit 1
            fi
          fi
          EOF

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/id_rsa

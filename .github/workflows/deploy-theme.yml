name: Deploy Child Themes & Elementor Kits to Cloudways

on:
  push:
    branches: [staging]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - site: sparky
            brand: sparky-hq
            app_secret: APP_ROOT_SPARKY_STAGING
          - site: hezlep
            brand: hezlep-inc
            app_secret: APP_ROOT_HEZLEP_STAGING

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare SSH key
        run: |
          set -euo pipefail
          echo "${{ secrets.CLOUDWAYS_SSH_KEY }}" > key.pem
          # Normalize Windows newlines just in case
          sed -i -e 's/\r$//' key.pem || true
          chmod 600 key.pem

      - name: Assemble Hello Child Theme
        run: |
          set -euo pipefail
          echo "Building theme for brand: ${{ matrix.brand }}"
          rm -rf infra/wordpress/themes/hello-child
          mkdir -p infra/wordpress/themes/hello-child
          # Prefer dedicated theme subfolder
          rsync -a --exclude '.git' --exclude 'node_modules' \
            "infra/wordpress/brands/${{ matrix.brand }}/theme/" \
            "infra/wordpress/themes/hello-child/" 2>/dev/null || true
          # Fallback: copy from brand root if no theme/ subfolder
          rsync -a --exclude '.git' --exclude 'node_modules' \
            "infra/wordpress/brands/${{ matrix.brand }}/" \
            "infra/wordpress/themes/hello-child/" 2>/dev/null || true

      - name: Deploy Hello Child Theme
        env:
          APP_ROOT: ${{ secrets[matrix.app_secret] }}
          CW_HOST: ${{ secrets.CLOUDWAYS_HOST }}
          CW_USER: ${{ secrets.CLOUDWAYS_USER }}
        run: |
          set -euo pipefail
          echo "Deploying Hello Child to $APP_ROOT"
          rsync -az --delete -e "ssh -i key.pem -o StrictHostKeyChecking=no" \
            infra/wordpress/themes/hello-child/ \
            "${CW_USER}@${CW_HOST}:${APP_ROOT}/wp-content/themes/hello-child/"

      - name: Upload Elementor Kit
        env:
          APP_ROOT: ${{ secrets[matrix.app_secret] }}
          CW_HOST: ${{ secrets.CLOUDWAYS_HOST }}
          CW_USER: ${{ secrets.CLOUDWAYS_USER }}
        run: |
          set -euo pipefail
          echo "Uploading Elementor Kit for brand: ${{ matrix.brand }}"
          rsync -az -e "ssh -i key.pem -o StrictHostKeyChecking=no" \
            "infra/wordpress/brands/${{ matrix.brand }}/elementor/cursor-sitekit.zip" \
            "${CW_USER}@${CW_HOST}:${APP_ROOT}/cursor-sitekit.zip"

      - name: Import Elementor Kit + Clear Cache
        env:
          APP_ROOT: ${{ secrets[matrix.app_secret] }}
          CW_HOST: ${{ secrets.CLOUDWAYS_HOST }}
          CW_USER: ${{ secrets.CLOUDWAYS_USER }}
        run: |
          set -euo pipefail
          ssh -i key.pem -o StrictHostKeyChecking=no "${CW_USER}@${CW_HOST}" <<REMOTE
set -e
cd "${APP_ROOT}"
echo "Activating theme..."
wp theme activate hello-child --allow-root || true
echo "Importing Elementor Kit..."
wp elementor import cursor-sitekit.zip --allow-root || echo "Kit import skipped or already applied."
echo "Flushing cache..."
wp cache flush --allow-root || true
if wp plugin is-installed breeze --allow-root; then
  wp breeze purge --allow-root || true
fi
REMOTE

      - name: Cleanup
        if: always()
        run: |
          rm -f key.pem

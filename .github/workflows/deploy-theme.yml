name: Deploy Child Themes & Elementor Kits to Cloudways

on:
  push:
    branches: [staging]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 1
      matrix:
        include:
          - site: sparky
            brand: sparky-hq
            app_secret: APP_ROOT_SPARKY_STAGING
          - site: hezlep
            brand: hezlep-inc
            app_secret: APP_ROOT_HEZLEP_STAGING

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare SSH key
        run: |
          set -euo pipefail
          echo "${{ secrets.CLOUDWAYS_SSH_KEY }}" > key.pem
          # Normalize Windows newlines just in case
          sed -i -e 's/\r$//' key.pem || true
          chmod 600 key.pem

      - name: Assemble Hello Child Theme
        run: |
          set -euo pipefail
          echo "Building theme for brand: ${{ matrix.brand }}"
          rm -rf infra/wordpress/themes/hello-child
          mkdir -p infra/wordpress/themes/hello-child
          # Prefer dedicated theme subfolder
          rsync -a --exclude '.git' --exclude 'node_modules' \
            "infra/wordpress/brands/${{ matrix.brand }}/theme/" \
            "infra/wordpress/themes/hello-child/" 2>/dev/null || true
          # Fallback: copy from brand root if no theme/ subfolder
          rsync -a --exclude '.git' --exclude 'node_modules' \
            "infra/wordpress/brands/${{ matrix.brand }}/" \
            "infra/wordpress/themes/hello-child/" 2>/dev/null || true

      - name: Deploy Hello Child Theme
        env:
          APP_ROOT: ${{ secrets[matrix.app_secret] }}
          CW_HOST: ${{ secrets.CLOUDWAYS_HOST }}
          CW_USER: ${{ secrets.CLOUDWAYS_USER }}
        run: |
          set -euo pipefail
          SSH_OPTS="-i key.pem -o StrictHostKeyChecking=no -o ServerAliveInterval=30 -o ServerAliveCountMax=4 -o ConnectionAttempts=5 -o TCPKeepAlive=yes"
          retry() { n=0; until "$@"; do n=$((n+1)); if [ $n -ge 5 ]; then echo "Failed after $n attempts" >&2; return 1; fi; sleep $((5*n)); done }
          echo "Deploying Hello Child to $APP_ROOT"
          retry ssh $SSH_OPTS "${CW_USER}@${CW_HOST}" "mkdir -p '$APP_ROOT/wp-content/themes/hello-child'"
          retry rsync -azvP --no-perms --no-times --omit-dir-times --delete -e "ssh $SSH_OPTS" \
            infra/wordpress/themes/hello-child/ \
            "${CW_USER}@${CW_HOST}:${APP_ROOT}/wp-content/themes/hello-child/"

      - name: Ensure remote assets dir
        env:
          APP_ROOT: ${{ secrets[matrix.app_secret] }}
          CW_HOST: ${{ secrets.CLOUDWAYS_HOST }}
          CW_USER: ${{ secrets.CLOUDWAYS_USER }}
        run: |
          set -euo pipefail
          SSH_OPTS="-i key.pem -o StrictHostKeyChecking=no -o ServerAliveInterval=30 -o ServerAliveCountMax=4 -o ConnectionAttempts=5 -o TCPKeepAlive=yes"
          ssh $SSH_OPTS "${CW_USER}@${CW_HOST}" "mkdir -p '$APP_ROOT/wp-content/themes/hello-child/assets/css'"

      - name: Verify remote theme files
        env:
          APP_ROOT: ${{ secrets[matrix.app_secret] }}
          CW_HOST: ${{ secrets.CLOUDWAYS_HOST }}
          CW_USER: ${{ secrets.CLOUDWAYS_USER }}
        run: |
          set -euo pipefail
          SSH_OPTS="-i key.pem -o StrictHostKeyChecking=no -o ServerAliveInterval=30 -o ServerAliveCountMax=4 -o ConnectionAttempts=5 -o TCPKeepAlive=yes"
          ssh $SSH_OPTS "${CW_USER}@${CW_HOST}" \
            "bash -lc 'set -e; \
              ls -lah \"${APP_ROOT}/wp-content/themes/hello-child\"; \
              for f in style.css functions.php; do \
                if [ -s \"${APP_ROOT}/wp-content/themes/hello-child/$f\" ]; then echo \"$f OK\"; else echo \"$f MISSING or empty\"; fi; \
              done; \
              if [ -d \"${APP_ROOT}/wp-content/themes/hello-child/hello-child\" ]; then echo \"WARNING: nested hello-child folder detected\"; fi'"

      - name: Upload Elementor Kit
        env:
          APP_ROOT: ${{ secrets[matrix.app_secret] }}
          CW_HOST: ${{ secrets.CLOUDWAYS_HOST }}
          CW_USER: ${{ secrets.CLOUDWAYS_USER }}
        run: |
          set -euo pipefail
          echo "Uploading Elementor Kit for brand: ${{ matrix.brand }}"
          SSH_OPTS="-i key.pem -o StrictHostKeyChecking=no -o ServerAliveInterval=30 -o ServerAliveCountMax=4 -o ConnectionAttempts=5 -o TCPKeepAlive=yes"
          retry() { n=0; until "$@"; do n=$((n+1)); if [ $n -ge 5 ]; then echo "Failed after $n attempts" >&2; return 1; fi; sleep $((5*n)); done }
          retry rsync -azvP --no-perms --no-times -e "ssh $SSH_OPTS" \
            "infra/wordpress/brands/${{ matrix.brand }}/elementor/cursor-sitekit.zip" \
            "${CW_USER}@${CW_HOST}:${APP_ROOT}/cursor-sitekit.zip"

      - name: Upload Tokens CSS (optional)
        env:
          APP_ROOT: ${{ secrets[matrix.app_secret] }}
          CW_HOST: ${{ secrets.CLOUDWAYS_HOST }}
          CW_USER: ${{ secrets.CLOUDWAYS_USER }}
        run: |
          set -euo pipefail
          SSH_OPTS="-i key.pem -o StrictHostKeyChecking=no -o ServerAliveInterval=30 -o ServerAliveCountMax=4 -o ConnectionAttempts=5 -o TCPKeepAlive=yes"
          CSS_PATH="infra/wordpress/brands/${{ matrix.brand }}/assets/css/cursor.css"
          if [ -f "$CSS_PATH" ]; then
            rsync -az --no-perms --no-times -e "ssh $SSH_OPTS" \
              "$CSS_PATH" \
              "${CW_USER}@${CW_HOST}:${APP_ROOT}/wp-content/themes/hello-child/assets/css/cursor.css"
          else
            echo "No brand tokens CSS found at $CSS_PATH (skipping)"
          fi

      - name: Import Elementor Kit + Clear Cache
        env:
          APP_ROOT: ${{ secrets[matrix.app_secret] }}
          CW_HOST: ${{ secrets.CLOUDWAYS_HOST }}
          CW_USER: ${{ secrets.CLOUDWAYS_USER }}
        run: |
          set -euo pipefail
          SSH_OPTS="-i key.pem -o StrictHostKeyChecking=no -o ServerAliveInterval=30 -o ServerAliveCountMax=4 -o ConnectionAttempts=5 -o TCPKeepAlive=yes"
          retry() { n=0; until "$@"; do n=$((n+1)); if [ $n -ge 5 ]; then echo "Failed after $n attempts" >&2; return 1; fi; sleep $((5*n)); done }
          retry ssh $SSH_OPTS "${CW_USER}@${CW_HOST}" \
            "bash -lc 'set -e; cd \"${APP_ROOT}\"; \
              echo Activating theme...; wp theme activate hello-child --allow-root || true; \
              echo Importing Elementor Kit...; wp elementor kit import cursor-sitekit.zip --allow-root || echo \"Kit import skipped or already applied.\"; \
              echo Flushing cache...; wp cache flush --allow-root || true; \
              if wp plugin is-installed breeze --allow-root; then wp breeze purge --allow-root || true; fi'"

      - name: Cleanup
        if: always()
        run: |
          rm -f key.pem

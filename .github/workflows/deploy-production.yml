name: Deploy to Production (Hello Child)

on:
  workflow_dispatch:
    inputs:
      site:
        description: 'sparky | hezlepinc'
        required: true
        default: 'hezlepinc'

concurrency:
  group: deploy-production
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.CLOUDWAYS_SSH_KEY }}

      - name: Resolve app root
        id: app
        env:
          SITE: ${{ inputs.site }}
          APP_ROOT_SPARKY_PROD: ${{ secrets.APP_ROOT_SPARKY_PROD }}
          APP_ROOT_HEZLEP_PROD: ${{ secrets.APP_ROOT_HEZLEP_PROD }}
        run: |
          if [ "$SITE" = "sparky" ]; then echo "root=$APP_ROOT_SPARKY_PROD" >> $GITHUB_OUTPUT; else echo "root=$APP_ROOT_HEZLEP_PROD" >> $GITHUB_OUTPUT; fi

      - name: Deploy Hello Child Theme
        run: |
          rsync -avz --omit-dir-times --no-perms \
            -e "ssh -o StrictHostKeyChecking=yes" \
            infra/wordpress/themes/hello-child/ \
            ${{ secrets.CLOUDWAYS_USER }}@${{ secrets.CLOUDWAYS_HOST }}:${{ steps.app.outputs.root }}/wp-content/themes/hello-child/ \
            --delete

      - name: Run post-deploy script
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.CLOUDWAYS_USER }}@${{ secrets.CLOUDWAYS_HOST }} \
          "cd ${{ steps.app.outputs.root }} && bash -s" < deploy/post-deploy.sh

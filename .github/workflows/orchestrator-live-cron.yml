name: Orchestrator Live Cache Snapshot

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 * * * *" # hourly

jobs:
  live-snapshot:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch live snapshot
        env:
          ORCH_URL: ${{ secrets.ORCHESTRATOR_URL }}
          # Use OPENAI_API_KEY as primary (matches orchestrator auth), fallback to AI_KEY for legacy
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          AI_KEY: ${{ secrets.AI_KEY }}
        run: |
          # Determine API key: prefer OPENAI_API_KEY, fallback to AI_KEY
          API_KEY="${OPENAI_API_KEY:-${AI_KEY}}"

          if [ -z "$ORCH_URL" ]; then
            echo "⚠️  Warning: ORCHESTRATOR_URL secret not set, skipping live snapshot"
            echo "{}" > live.json
            exit 0
          fi
          if [ -z "$API_KEY" ]; then
            echo "⚠️  Warning: Neither OPENAI_API_KEY nor AI_KEY secret is set, skipping live snapshot"
            echo "Set OPENAI_API_KEY (preferred) or AI_KEY in repository secrets to enable live snapshot"
            echo "{}" > live.json
            exit 0
          fi
          echo "Fetching live snapshot from $ORCH_URL/ai/live"
          curl -sS -H "x-api-key: $API_KEY" "$ORCH_URL/ai/live" | tee live.json || {
            echo "⚠️  Warning: Failed to fetch live snapshot, creating empty artifact"
            echo "{}" > live.json
          }
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: orchestrator-live-snapshot
          path: live.json
          retention-days: 3



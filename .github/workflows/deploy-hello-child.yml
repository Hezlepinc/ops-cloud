name: Deploy Hello Child Theme (Staging)

on:
  push:
    branches: [ staging ]
  workflow_dispatch:
    inputs:
      brand:
        description: "Optional brand key to copy from infra/brands/<brand> into hello-child"
        required: false
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - site: sparky
            brand_slug: sparky-hq
            app_root_secret: APP_ROOT_SPARKY_STAGING
          - site: hezlepinc
            brand_slug: hezlep-inc
            app_root_secret: APP_ROOT_HEZLEP_STAGING
    env:
      BRAND: ${{ inputs.brand }}
      SITE: ${{ matrix.site }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare SSH key
        env:
          SSH_KEY: ${{ secrets.CLOUDWAYS_SSH_KEY }}
          CLOUDWAYS_HOST: ${{ secrets.CLOUDWAYS_HOST }}
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          if echo "$SSH_KEY" | grep -q "BEGIN "; then
            printf "%s\n" "$SSH_KEY" > ~/.ssh/id_rsa
          else
            echo "$SSH_KEY" | base64 -d > ~/.ssh/id_rsa || (echo "Failed to decode base64 SSH key" >&2; exit 1)
          fi
          sed -i -e 's/\r$//' ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keygen -y -f ~/.ssh/id_rsa >/dev/null 2>&1 || (echo "Invalid SSH key content" >&2; exit 1)
          ssh-keyscan -H "$CLOUDWAYS_HOST" >> ~/.ssh/known_hosts

      - name: Optional - Copy brand child theme into hello-child
        run: |
          set -euo pipefail
          THEME_DIR="infra/wordpress/themes/hello-child"
          mkdir -p "$THEME_DIR"
          # Prefer repo path infra/brands/<brand> if provided and exists
          if [ -n "${BRAND:-}" ] && [ -d "infra/brands/${BRAND}" ]; then
            rsync -a --delete --exclude '.git' --exclude 'node_modules' "infra/brands/${BRAND}/" "$THEME_DIR/"
          fi
          # Fallback to repo path infra/wordpress/brands/<brand>/theme if exists
          if [ -n "${BRAND:-}" ] && [ -d "infra/wordpress/brands/${BRAND}/theme" ]; then
            rsync -a --delete --exclude '.git' --exclude 'node_modules' "infra/wordpress/brands/${BRAND}/theme/" "$THEME_DIR/"
          fi

      - name: Deploy hello-child via rsync
        env:
          CLOUDWAYS_HOST: ${{ secrets.CLOUDWAYS_HOST }}
          CLOUDWAYS_USER: ${{ secrets.CLOUDWAYS_USER }}
          APP_ROOT: ${{ secrets[matrix.app_root_secret] }}
        run: |
          set -euo pipefail
          SSH_OPTS="-i ~/.ssh/id_rsa -o StrictHostKeyChecking=no"
          # Ensure remote directory exists
          ssh $SSH_OPTS "${CLOUDWAYS_USER}@${CLOUDWAYS_HOST}" "mkdir -p '$APP_ROOT/wp-content/themes/hello-child'"
          # Rsync theme (exclude common junk)
          rsync -az --delete \
            --exclude '.git' --exclude '.github' --exclude 'node_modules' --exclude '*.map' --exclude '.DS_Store' \
            -e "ssh $SSH_OPTS" \
            infra/wordpress/themes/hello-child/ \
            "${CLOUDWAYS_USER}@${CLOUDWAYS_HOST}:${APP_ROOT}/wp-content/themes/hello-child/"

      - name: Cleanup (no-op)
        run: |
          echo "Deployment complete."



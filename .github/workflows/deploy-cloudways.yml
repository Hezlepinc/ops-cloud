name: Deploy to Cloudways (Staging)

on:
  push:
    branches: [staging]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - site: sparky
            app_root_secret: APP_ROOT_SPARKY_STAGING
          - site: hezlepinc
            app_root_secret: APP_ROOT_HEZLEP_STAGING

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # === Prepare SSH key ===
      - name: Prepare SSH key
        env:
          SSH_KEY: ${{ secrets.CLOUDWAYS_SSH_KEY }}
          CLOUDWAYS_HOST: ${{ secrets.CLOUDWAYS_HOST }}
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          if echo "$SSH_KEY" | grep -q "BEGIN "; then
            printf "%s\n" "$SSH_KEY" > ~/.ssh/id_rsa
          else
            echo "$SSH_KEY" | base64 -d > ~/.ssh/id_rsa || (echo "Failed to decode base64 SSH key" >&2; exit 1)
          fi
          # Normalize line endings for Windows users
          sed -i -e 's/\r$//' ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          # Validate key content
          ssh-keygen -y -f ~/.ssh/id_rsa >/dev/null 2>&1 || (echo "Invalid SSH key content" >&2; exit 1)
          # Trust the Cloudways host
          ssh-keyscan -H "$CLOUDWAYS_HOST" >> ~/.ssh/known_hosts

      - name: Deploy site via script
        env:
          CLOUDWAYS_HOST: ${{ secrets.CLOUDWAYS_HOST }}
          CLOUDWAYS_USER: ${{ secrets.CLOUDWAYS_USER }}
          APP_ROOT: ${{ secrets[matrix.app_root_secret] }}
        run: |
          set -euo pipefail
          echo "ðŸš€ Deploying ${{ matrix.site }} to staging..."
          bash scripts/deploy.sh --site=${{ matrix.site }} --env=staging

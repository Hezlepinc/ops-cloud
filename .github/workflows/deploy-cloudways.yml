name: Deploy to Cloudways (Staging - Legacy)

on:
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # === Prepare SSH key ===
      - name: Prepare SSH key
        env:
          SSH_KEY: ${{ secrets.CLOUDWAYS_SSH_KEY }}
          CLOUDWAYS_HOST: ${{ secrets.CLOUDWAYS_HOST }}
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          if echo "$SSH_KEY" | grep -q "BEGIN "; then
            printf "%s\n" "$SSH_KEY" > ~/.ssh/id_rsa
          else
            echo "$SSH_KEY" | base64 -d > ~/.ssh/id_rsa || (echo "Failed to decode base64 SSH key" >&2; exit 1)
          fi
          # Normalize line endings for Windows users
          sed -i -e 's/\r$//' ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          # Validate key content
          ssh-keygen -y -f ~/.ssh/id_rsa >/dev/null 2>&1 || (echo "Invalid SSH key content" >&2; exit 1)
          # Trust the Cloudways host
          ssh-keyscan -H "$CLOUDWAYS_HOST" >> ~/.ssh/known_hosts

      # === Deploy via rsync ===
      - name: Deploy via rsync
        env:
          CLOUDWAYS_HOST: ${{ secrets.CLOUDWAYS_HOST }}
          CLOUDWAYS_USER: ${{ secrets.CLOUDWAYS_USER }}
          APP_ROOT: ${{ secrets.APP_ROOT_SPARKY_STAGING }}
        run: |
          set -euo pipefail
          echo "üîÑ Deploying theme to Cloudways..."
          rsync -az --no-perms --no-times --omit-dir-times --delete -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
            infra/wordpress/themes/hello-child/ \
            "${CLOUDWAYS_USER}@${CLOUDWAYS_HOST}:${APP_ROOT}/wp-content/themes/hello-child/"

      # === Activate theme + flush cache ===
      - name: Activate theme and flush cache
        env:
          CLOUDWAYS_HOST: ${{ secrets.CLOUDWAYS_HOST }}
          CLOUDWAYS_USER: ${{ secrets.CLOUDWAYS_USER }}
          APP_ROOT: ${{ secrets.APP_ROOT_SPARKY_STAGING }}
        run: |
          set -euo pipefail
          echo "‚öôÔ∏è  Activating theme and flushing cache..."
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
            "${CLOUDWAYS_USER}@${CLOUDWAYS_HOST}" \
            "cd ${APP_ROOT} && wp theme activate hello-child --allow-root && wp cache flush --allow-root"

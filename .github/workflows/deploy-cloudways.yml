name: Deploy Theme to Cloudways

on:
  push:
    branches:
      - main
      - staging
    paths:
      - 'infra/**'
      - 'themes/**'
      - 'plugins/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        site: [hezlepinc, sparky]
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
      - name: Install rsync and jq
        run: sudo apt-get update && sudo apt-get install -y rsync jq

      - name: Write SSH key
        env:
          SSH_KEY: ${{ secrets.CLOUDWAYS_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_rsa
          # Normalize line endings (fix CRLF causing libcrypto errors)
          sed -i -e 's/\r$//' ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          # Validate key parses
          ssh-keygen -y -f ~/.ssh/id_rsa >/dev/null 2>&1 || (echo "Invalid SSH key content" >&2; exit 1)

      - name: Add host to known_hosts
        env:
          CLOUDWAYS_HOST: ${{ secrets.CLOUDWAYS_HOST }}
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "$CLOUDWAYS_HOST" >> ~/.ssh/known_hosts

      - name: Test SSH connection
        env:
          CLOUDWAYS_HOST: ${{ secrets.CLOUDWAYS_HOST }}
          CLOUDWAYS_USER: ${{ secrets.CLOUDWAYS_USER }}
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no "$CLOUDWAYS_USER@$CLOUDWAYS_HOST" "echo 'âœ… SSH OK:' $(hostname)"

      - name: Determine environment
        id: env
        run: |
          BRANCH="${GITHUB_REF_NAME}"
          if [ "$BRANCH" = "main" ]; then echo "env=production" >> $GITHUB_OUTPUT; else echo "env=staging" >> $GITHUB_OUTPUT; fi

      - name: Setup Node (for build-cursor)
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        run: npm i -g pnpm@9.11.0

      - name: Build Cursor tokens
        env:
          DEPLOY_SITE: ${{ matrix.site }}
        run: pnpm run build-cursor

      - name: Validate inputs
        run: |
          if [ -z "${{ matrix.site }}" ]; then echo "Missing site key" >&2; exit 1; fi

      - name: Deploy via script
        env:
          CLOUDWAYS_HOST: ${{ secrets.CLOUDWAYS_HOST }}
          CLOUDWAYS_USER: ${{ secrets.CLOUDWAYS_USER }}
          DEPLOY_SITE: ${{ matrix.site }}
          PLUGINS: 'elementor,breeze,wordpress-seo,header-footer-elementor,contact-form-7'
        run: |
          set -euo pipefail
          echo "Deploying site=${DEPLOY_SITE} env=${{ steps.env.outputs.env }}"
          bash scripts/deploy.sh --site="${DEPLOY_SITE}" --env=${{ steps.env.outputs.env }}
